<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Decisão de Campanhas</title>
    <!--
      // Estilos CSS do Painel - Layout, tema e componentes.
      // -----------------------------------------------------------------------
    -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            --cor-fundo: #f4f7f9;
            --cor-card-fundo: #ffffff;
            --cor-texto-principal: #333333;
            --cor-texto-secundario: #666666;
            --cor-borda: #e1e8ed;
            --sombra-leve: 0 4px 12px rgba(0, 0, 0, 0.05);
            --borda-arredondada: 12px;
            --azul-claro: #eff6ff;
            --azul-escuro: #1d4ed8;
            --verde-bom: #28a745;
            --amarelo-ajuste: #ffc107;
            --vermelho-pausar: #dc3545;
            --vermelho-texto: #b41d2d;
            --rosa-fofo: #E75191;
            --amarelo-sol: #FFD400;
        }

        /* Estilos de impressão para PDF */
        @media print {
            body {
                background-color: #fff !important;
                color: #000 !important;
                font-family: 'Inter', sans-serif;
            }
            .no-print { display: none !important; }
            .container { padding: 0 !important; margin: 0 !important; max-width: none !important; }
            .dashboard-grid { grid-template-columns: 1fr; gap: 20px; }
            .card {
                box-shadow: none;
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }
            .card-title, .card-decision-text { font-size: 1.2rem; font-weight: bold; }
            .card-metrics { display: none; }
            .card-reason { display: block; }
            .card-actions { margin-top: 10px; }
            .card-actions ul { list-style: disc; padding-left: 20px; }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto-principal);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            text-align: center;
            padding: 20px;
        }

        header h1 {
            color: var(--rosa-fofo);
            font-size: 2.5rem;
            margin: 0;
        }

        header p {
            color: var(--cor-texto-secundario);
            font-size: 1rem;
            max-width: 800px;
            margin: 10px auto 0;
        }

        .top-bar {
            background-color: var(--cor-card-fundo);
            padding: 20px;
            border-radius: var(--borda-arredondada);
            box-shadow: var(--sombra-leve);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
        }
        
        .upload-section, .filter-section, .goals-section {
            flex: 1;
            min-width: 250px;
        }

        .upload-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .upload-buttons, .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--azul-escuro);
            color: #fff;
        }
        
        .btn-secondary {
            background-color: var(--cor-borda);
            color: var(--cor-texto-principal);
        }

        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-leve);
        }

        .input-file {
            display: flex;
            flex-direction: column;
        }
        
        .input-file label {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: var(--cor-texto-secundario);
        }
        
        .input-file input[type="file"] {
            display: none;
        }
        
        .custom-file-upload {
            border: 2px dashed var(--cor-borda);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s ease;
            font-size: 0.9rem;
        }
        
        .custom-file-upload:hover {
            border-color: var(--azul-escuro);
        }

        .goals-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .goal-slider {
            display: flex;
            flex-direction: column;
        }
        
        .goal-slider label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .goal-slider input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #e1e8ed;
            border-radius: 4px;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .goal-slider input[type="range"]:hover {
            opacity: 1;
        }
        
        .goal-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--azul-escuro);
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
        }

        .goal-value {
            font-weight: 600;
            margin-left: auto;
            color: var(--azul-escuro);
        }

        .main-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .dashboard {
            flex: 3;
            min-width: 300px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background-color: var(--cor-card-fundo);
            padding: 20px;
            border-radius: var(--borda-arredondada);
            box-shadow: var(--sombra-leve);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-decision {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            color: white;
            white-space: nowrap;
        }

        .status-bom { background-color: var(--verde-bom); }
        .status-ajuste { background-color: var(--amarelo-ajuste); }
        .status-pausar { background-color: var(--vermelho-pausar); }

        .card-decision-text {
            font-size: 0.9rem;
            margin-top: 10px;
            font-weight: 600;
            color: var(--cor-texto-secundario);
        }
        .status-pausar-text { color: var(--vermelho-texto); }

        .card-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .metric {
            display: flex;
            flex-direction: column;
        }

        .metric-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--cor-texto-secundario);
        }

        .card-reason {
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--cor-texto-principal);
            font-weight: 600;
        }
        
        .card-reason::before {
            content: 'Por quê: ';
            font-weight: 700;
        }

        .card-actions {
            margin-top: 15px;
        }
        
        .card-actions ul {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.9rem;
        }
        
        .card-actions li {
            margin-bottom: 5px;
        }
        
        .card-actions li::before {
            content: '•';
            color: var(--azul-escuro);
            font-weight: 700;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }

        .card-actions strong {
            color: var(--azul-escuro);
        }

        .glossary-panel {
            flex: 1;
            background-color: var(--cor-card-fundo);
            padding: 20px;
            border-radius: var(--borda-arredondada);
            box-shadow: var(--sombra-leve);
            min-width: 250px;
        }
        
        .charts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }

        .chart-card {
            background-color: var(--cor-card-fundo);
            padding: 20px;
            border-radius: var(--borda-arredondada);
            box-shadow: var(--sombra-leve);
            flex: 1;
            min-width: 300px;
        }

        .chart-card canvas {
            max-width: 100%;
            height: auto;
        }
        
        .export-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .drawer-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        
        .drawer-content {
            background-color: var(--cor-card-fundo);
            padding: 20px;
            border-radius: var(--borda-arredondada);
            box-shadow: var(--sombra-leve);
            width: 90%;
            max-width: 800px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-btn:hover, .close-btn:focus {
            color: #000;
        }

        .glossary-panel {
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip-text {
            visibility: hidden;
            width: 150px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position the tooltip above the text */
            left: 50%;
            margin-left: -75px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .message-box {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9rem;
            display: none;
        }

    </style>
</head>
<body>
    <div class="container">
        <!--
          // Seção de Cabeçalho e Descrição
          // -----------------------------------------------------------------------
        -->
        <header class="no-print">
            <h1>Decisões de Campanhas</h1>
            <p>
                Analise e tome decisões inteligentes para suas campanhas de marketing! Suba dois arquivos CSV (um do Meta Ads e outro do Google Analytics 4) e eu te ajudo a entender o que está funcionando e o que precisa de ajustes, com um plano de ação simples e direto.
            </p>
        </header>

        <!--
          // Topbar com Uploads, Metas e Filtros
          // -----------------------------------------------------------------------
        -->
        <div class="top-bar no-print">
            <div class="upload-section">
                <h3>1. Suba seus dados</h3>
                <div class="upload-buttons">
                    <div class="input-file">
                        <label for="meta-csv-input" class="custom-file-upload">Meta Ads CSV</label>
                        <input type="file" id="meta-csv-input" accept=".csv">
                        <span id="meta-filename"></span>
                    </div>
                    <div class="input-file">
                        <label for="ga4-csv-input" class="custom-file-upload">GA4 CSV</label>
                        <input type="file" id="ga4-csv-input" accept=".csv">
                        <span id="ga4-filename"></span>
                    </div>
                </div>
                <div id="file-error-message" class="message-box"></div>
                <button id="load-example-btn" class="btn btn-secondary">Carregar dados de exemplo</button>
            </div>
            
            <div class="goals-section">
                <h3>2. Defina suas metas</h3>
                <div class="goal-slider">
                    <label>minCTR <span id="minCTR-val" class="goal-value"></span></label>
                    <input type="range" id="minCTR" min="0" max="10" step="0.1">
                </div>
                <div class="goal-slider">
                    <label>maxCPC <span id="maxCPC-val" class="goal-value"></span></label>
                    <input type="range" id="maxCPC" min="0.5" max="10" step="0.1">
                </div>
                <div class="goal-slider">
                    <label>minCVR <span id="minCVR-val" class="goal-value"></span></label>
                    <input type="range" id="minCVR" min="0" max="10" step="0.1">
                </div>
                <div class="goal-slider">
                    <label>maxCPA <span id="maxCPA-val" class="goal-value"></span></label>
                    <input type="range" id="maxCPA" min="10" max="100" step="1">
                </div>
                <div class="goal-slider">
                    <label>minROAS <span id="minROAS-val" class="goal-value"></span></label>
                    <input type="range" id="minROAS" min="0.5" max="5" step="0.1">
                </div>
                <div class="goal-slider">
                    <label>maxFrequencia <span id="maxFrequencia-val" class="goal-value"></span></label>
                    <input type="range" id="maxFrequencia" min="1" max="5" step="0.1">
                </div>
                <div class="goal-slider">
                    <label>limiteGastoSemVenda <span id="limiteGastoSemVenda-val" class="goal-value"></span></label>
                    <input type="range" id="limiteGastoSemVenda" min="20" max="200" step="5">
                </div>
            </div>

            <div class="filter-section">
                <h3>3. Filtros</h3>
                <input type="text" id="campaign-filter" placeholder="Buscar por nome da campanha..." style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
            </div>
        </div>

        <!--
          // Conteúdo Principal com Dashboard e Glossário
          // -----------------------------------------------------------------------
        -->
        <main class="main-content">
            <div class="dashboard">
                <h2>Resultados das Campanhas</h2>
                <div id="loading-message" style="display: none; text-align: center; color: var(--cor-texto-secundario);">Carregando e processando dados...</div>
                <div id="no-data-message" style="display: block; text-align: center; color: var(--cor-texto-secundario);">
                    Suba seus arquivos CSV ou clique em "Carregar dados de exemplo" para começar.
                </div>
                <div id="dashboard-grid" class="dashboard-grid"></div>
            </div>
            
            <!-- Painel lateral para o Glossário -->
            <aside class="glossary-panel no-print">
                <h3>Glossário Rápido</h3>
                <ul>
                    <li><strong>CTR:</strong> de cada 100 pessoas que viram, quantas clicaram.</li>
                    <li><strong>CPC:</strong> preço de cada clique que você recebeu.</li>
                    <li><strong>CPA:</strong> preço de cada compra ou resultado.</li>
                    <li><strong>ROAS:</strong> quanto voltou de dinheiro para cada R$ 1 que você investiu.</li>
                    <li><strong>Frequência:</strong> quantas vezes a mesma pessoa viu seu anúncio.</li>
                    <li><strong>CVR:</strong> de cada 100 pessoas que clicaram, quantas compraram.</li>
                </ul>
            </aside>
        </main>
        
        <!--
          // Seção de Gráficos e Exportação
          // -----------------------------------------------------------------------
        -->
        <div id="chart-section" class="charts-container no-print" style="display: none;">
            <div class="chart-card">
                <h3>Gasto por Campanha</h3>
                <canvas id="gasto-chart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Receita por Campanha</h3>
                <canvas id="receita-chart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Decisões por Status</h3>
                <canvas id="decisoes-chart"></canvas>
            </div>
        </div>

        <div class="export-buttons no-print">
            <button id="export-csv-btn" class="btn btn-secondary" style="display: none;">Exportar Plano de Ação (CSV)</button>
            <button id="export-pdf-btn" class="btn btn-secondary" style="display: none;">Imprimir/Salvar PDF</button>
        </div>

        <!--
          // Modal de Detalhes da Campanha
          // -----------------------------------------------------------------------
        -->
        <div id="drawer-modal" class="drawer-modal">
            <div class="drawer-content">
                <span class="close-btn">&times;</span>
                <h3 id="drawer-title">Detalhes da Campanha</h3>
                <div id="drawer-content"></div>
            </div>
        </div>
    </div>

    <!--
      // Lógica JavaScript
      // -----------------------------------------------------------------------
    -->
    <script>
        // Objeto de Configuração Global
        const CONFIG = {
            // Metas e limites padrão para o motor de decisão
            METAS: {
                minCTR: 1.0,
                maxCPC: 1.50,
                minCVR: 2.5,
                maxCPA: 35.00,
                minROAS: 2.0,
                maxFrequencia: 3.0,
                limiteGastoSemVenda: 80.00
            },
            // Mapeamento de sinônimos de colunas para normalização
            COLUMNS: {
                meta: {
                    'Campanha': ['campanha', 'nome da campanha', 'campaign'],
                    'Conjunto': ['conjunto', 'ad set'],
                    'Anúncio': ['anúncio', 'ad'],
                    'Impressões': ['impressões', 'impressions'],
                    'Alcance': ['alcance', 'reach'],
                    'Cliques': ['cliques', 'cliques no link', 'clicks'],
                    'CTR': ['ctr', 'click-through rate'],
                    'CPC': ['cpc', 'cost per click'],
                    'CPM': ['cpm', 'cost per mille'],
                    'Gasto': ['gasto', 'valor usado', 'spend', 'amount spent'],
                    'Resultados': ['resultados', 'conversões', 'conversions', 'compras', 'purchases'],
                    'Custo por resultado': ['custo por resultado', 'cost per result'],
                    'Data início': ['data início', 'start date'],
                    'Data término': ['data término', 'end date'],
                    'Receita': ['receita', 'revenue'],
                },
                ga4: {
                    'Campanha': ['campanha', 'campaign'],
                    'Sessões': ['sessões', 'sessions'],
                    'Usuários': ['usuários', 'users'],
                    'Tempo engajado médio': ['tempo engajado médio', 'avg_engagement_time'],
                    'Add_to_cart': ['add_to_cart'],
                    'Begin_checkout': ['begin_checkout'],
                    'Compras': ['compras', 'purchases'],
                    'Receita': ['receita', 'revenue']
                }
            },
            // Mensagens e sugestões para o motor de decisão
            MESSAGES: {
                PAUSAR_GASTO: (gasto) => `Pare agora: gastou R$ ${gasto} e não vendeu nada.`,
                PAUSAR_METRICAS: 'Pare: pouca gente clica e quem clica não compra.',
                TROCAR_CRIATIVO: 'Quase ninguém clica e quem clica não compra. Troque imagem, título e deixe o preço claro.',
                AJUSTAR_PUBLICO: 'Quem clica compra, mas quase ninguém clica. Troque o público para achar mais pessoas parecidas.',
                MELHORAR_PAGINA: 'Muita gente entra, quase ninguém fecha. Melhore a página: prova social, frete, prazos e confiança.',
                AUMENTAR: (percent) => `Está valendo a pena! Aumente +${percent}% o orçamento e acompanhe.`,
                MANTER: 'Está dentro das metas. Continue como está.',
                SUGESTOES: {
                    TROCAR_CRIATIVO: [
                        'Use foto do produto no pé em fundo limpo',
                        'Coloque preço, parcelamento e frete visíveis',
                        'Teste vídeo curto (3-7s) com primeiro quadro chamativo'
                    ],
                    AJUSTAR_PUBLICO: [
                        'Teste Lookalike de compradores (1-5%)',
                        'Interesses: [produto], [ocasião], [estilo]',
                        'Geo: priorize estados com melhor ROAS'
                    ],
                    MELHORAR_PAGINA: [
                        'Adicione depoimentos e selos de confiança',
                        'Frete e prazo claros acima da dobra',
                        'Botão "Comprar" visível e fixo no mobile'
                    ]
                }
            },
            // Dados de exemplo para teste
            SAMPLE_DATA: {
                meta: `Campanha,Gasto,Resultados,Cliques,Impressões,Alcance,CTR,Custo por resultado
Campanha A,500,10,2500,500000,400000,0.5%,50.00
Campanha B,85,0,100,20000,15000,0.5%,-
Campanha C,250,5,3000,100000,90000,3.0%,50.00
Campanha D,1000,40,5000,200000,150000,2.5%,25.00
Campanha E,150,1,100,50000,45000,0.2%,150.00
Campanha F,300,10,500,100000,80000,0.5%,30.00`,
                ga4: `Campanha,Sessões,Compras,Receita
Campanha A,1500,10,3500.00
Campanha B,200,0,0
Campanha C,400,5,1500.00
Campanha D,5500,40,15000.00
Campanha E,120,1,200.00
Campanha G,50,0,0` // Exemplo de campanha só no GA4
            }
        };

        // Estado da aplicação
        let rawData = { meta: [], ga4: [] };
        let joinedData = [];
        let campaignsToShow = [];

        // Elementos da UI
        const metaFileInput = document.getElementById('meta-csv-input');
        const ga4FileInput = document.getElementById('ga4-csv-input');
        const dashboardGrid = document.getElementById('dashboard-grid');
        const loadingMessage = document.getElementById('loading-message');
        const noDataMessage = document.getElementById('no-data-message');
        const campaignFilterInput = document.getElementById('campaign-filter');
        const goalsInputs = document.querySelectorAll('.goal-slider input[type="range"]');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const chartSection = document.getElementById('chart-section');
        const drawerModal = document.getElementById('drawer-modal');
        const closeDrawerBtn = document.querySelector('.close-btn');
        const fileErrorMessage = document.getElementById('file-error-message');

        // --- SEÇÃO 1: FUNÇÕES DE UTILIDADE E PARSING ---

        /**
         * Normaliza uma string para comparação (minusculo, sem acentos, sem espacos extras).
         * @param {string} str
         * @returns {string}
         */
        const normalizeString = (str) => {
            if (typeof str !== 'string') return '';
            return str.trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        };

        /**
         * Detecta e converte uma string de número para float.
         * Suporta separadores de milhar e vírgula/ponto como decimal.
         * @param {string} str
         * @returns {number|null}
         */
        const parseNumber = (str) => {
            if (typeof str !== 'string') return str;
            let normalized = str.replace(/\./g, '').replace(',', '.').trim();
            let num = parseFloat(normalized);
            return isNaN(num) ? null : num;
        };

        /**
         * Detecta e converte uma string de data para um objeto Date.
         * Suporta dd/mm/aaaa e aaaa-mm-dd.
         * @param {string} str
         * @returns {Date|null}
         */
        const parseDate = (str) => {
            if (typeof str !== 'string' || !str.trim()) return null;
            const parts = str.split(/[\/\-]/);
            if (parts.length === 3) {
                // dd/mm/aaaa
                if (parts[0].length === 2 && parts[1].length === 2) {
                    return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                }
                // aaaa-mm-dd
                if (parts[0].length === 4) {
                    return new Date(`${parts[0]}-${parts[1]}-${parts[2]}`);
                }
            }
            return null;
        };

        /**
         * Função principal de parsing de CSV, que detecta o delimitador.
         * @param {string} csvText
         * @returns {Array<Object>}
         */
        const parseCSV = (csvText) => {
            if (!csvText) return [];
            
            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length < 2) return [];

            let delimiter = ',';
            if (lines[0].includes(';')) {
                delimiter = ';';
            }

            const headers = lines[0].split(delimiter).map(h => normalizeString(h));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;

                const values = line.split(delimiter);
                const row = {};

                for (let j = 0; j < headers.length; j++) {
                    const header = headers[j];
                    const value = values[j] ? values[j].trim() : '';

                    // Normalizar valores numéricos e de data
                    let parsedValue = parseNumber(value);
                    if (parsedValue === null) {
                        parsedValue = parseDate(value);
                    }
                    if (parsedValue === null) {
                        parsedValue = value;
                    }
                    row[header] = parsedValue;
                }
                data.push(row);
            }
            return data;
        };
        
        /**
         * Mapeia os cabeçalhos do CSV para os nomes normalizados.
         * @param {Array<Object>} data
         * @param {string} type 'meta' or 'ga4'
         * @returns {Array<Object>}
         */
        const mapDataToNormalizedHeaders = (data, type) => {
            if (!data || data.length === 0) return [];
            const normalizedData = [];
            const headerMap = {};
            const firstRow = data[0];

            for (const key in firstRow) {
                const normalizedKey = normalizeString(key);
                for (const mappedKey in CONFIG.COLUMNS[type]) {
                    if (CONFIG.COLUMNS[type][mappedKey].includes(normalizedKey)) {
                        headerMap[key] = mappedKey;
                        break;
                    }
                }
                // Se não encontrou, mantém o original
                if (!headerMap[key]) {
                    headerMap[key] = key;
                }
            }
            
            data.forEach(row => {
                const newRow = {};
                for (const key in row) {
                    const newKey = headerMap[key];
                    newRow[newKey] = row[key];
                }
                normalizedData.push(newRow);
            });

            return normalizedData;
        };


        // --- SEÇÃO 2: UNIÃO DOS DADOS ---

        /**
         * Une os dados do Meta e do GA4 com base no nome da campanha.
         * @param {Array<Object>} metaData
         * @param {Array<Object>} ga4Data
         * @returns {Array<Object>}
         */
        const joinData = (metaData, ga4Data) => {
            const joined = {};

            metaData.forEach(row => {
                const campaignName = normalizeString(row['Campanha']);
                if (campaignName) {
                    if (!joined[campaignName]) {
                        joined[campaignName] = { isPartial: true, meta: {}, ga4: {} };
                    }
                    joined[campaignName].meta = row;
                    joined[campaignName].isPartial = false;
                }
            });

            ga4Data.forEach(row => {
                const campaignName = normalizeString(row['Campanha']);
                if (campaignName) {
                    if (!joined[campaignName]) {
                        joined[campaignName] = { isPartial: true, meta: {}, ga4: {} };
                    }
                    joined[campaignName].ga4 = row;
                    if (Object.keys(joined[campaignName].meta).length > 0) {
                        joined[campaignName].isPartial = false;
                    }
                }
            });

            return Object.values(joined);
        };


        // --- SEÇÃO 3: CÁLCULOS E MOTOR DE DECISÃO ---
        
        /**
         * Formata um número para moeda BRL.
         * @param {number|string|null} value
         * @returns {string}
         */
        const formatCurrency = (value) => {
            if (value === null || typeof value !== 'number' || isNaN(value)) {
                return 'R$ —';
            }
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        };

        /**
         * Formata um número como porcentagem.
         * @param {number|string|null} value
         * @returns {string}
         */
        const formatPercent = (value) => {
            if (value === null || typeof value !== 'number' || isNaN(value)) {
                return '—%';
            }
            return new Intl.NumberFormat('pt-BR', {
                style: 'percent',
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            }).format(value / 100);
        };

        /**
         * Calcula todas as métricas derivadas para uma campanha.
         * @param {Object} campaignData
         * @returns {Object}
         */
        const calculateMetrics = (campaignData) => {
            const { meta, ga4 } = campaignData;
            
            const impressoes = parseNumber(meta['Impressões']);
            const alcance = parseNumber(meta['Alcance']);
            const cliques = parseNumber(meta['Cliques']);
            const gasto = parseNumber(meta['Gasto']);
            const resultados = parseNumber(meta['Resultados']);
            const comprasMeta = parseNumber(meta['Compras'] || 0);
            const receitaMeta = parseNumber(meta['Receita'] || 0);

            const comprasGA4 = parseNumber(ga4['Compras']);
            const receitaGA4 = parseNumber(ga4['Receita']);
            const sessoesGA4 = parseNumber(ga4['Sessões']);
            const tempoEngajadoGA4 = parseNumber(ga4['Tempo engajado médio']);

            const metrics = {
                // Meta
                Impressões: impressoes,
                Alcance: alcance,
                Cliques: cliques,
                Gasto: gasto,
                Resultados: resultados,
                ReceitaMeta: receitaMeta,
                ComprasMeta: comprasMeta,
                // GA4
                SessoesGA4: sessoesGA4,
                ReceitaGA4: receitaGA4,
                ComprasGA4: comprasGA4,
                TempoEngajadoGA4: tempoEngajadoGA4,
                // Derivadas
                Frequencia: alcance ? (impressoes / alcance) : null,
                CTR: impressoes ? (cliques / impressoes) * 100 : null,
                CPC: cliques ? (gasto / cliques) : null,
                CPM: impressoes ? (gasto / impressoes) * 1000 : null,
                CVR: cliques ? (resultados || comprasMeta) / cliques * 100 : null,
                CPA: (resultados || comprasMeta) ? gasto / (resultados || comprasMeta) : Infinity,
                ROAS: (receitaMeta || receitaGA4) ? (receitaMeta || receitaGA4) / gasto : null
            };

            return metrics;
        };

        /**
         * Aplica o motor de decisão em uma campanha.
         * @param {Object} metrics
         * @param {Object} metas
         * @returns {Object}
         */
        const makeDecision = (metrics, metas) => {
            const { Gasto, Resultados, Cliques, Impressões, CTR, CVR, CPC, CPA, ROAS, Frequencia } = metrics;
            const { minCTR, maxCPC, minCVR, maxCPA, minROAS, maxFrequencia, limiteGastoSemVenda } = metas;
            
            // Regra 1: PAUSAR
            if ((Gasto >= limiteGastoSemVenda && (Resultados === 0 || Resultados === null)) || 
                (CPC > maxCPC && CTR < minCTR) || 
                (Frequencia > maxFrequencia)) {
                
                let motivo = '';
                if (Gasto >= limiteGastoSemVenda && (Resultados === 0 || Resultados === null)) {
                    motivo = CONFIG.MESSAGES.PAUSAR_GASTO(Gasto.toFixed(2));
                } else if (CPC > maxCPC && CTR < minCTR) {
                    motivo = CONFIG.MESSAGES.PAUSAR_METRICAS;
                } else {
                    motivo = 'A mesma pessoa viu seu anúncio muitas vezes. O anúncio já cansou e parou de funcionar.';
                }

                return {
                    decisao: 'PAUSAR',
                    cor: 'vermelho-pausar',
                    motivo: motivo,
                    sugestoes: []
                };
            }

            // Regra 2: TROCAR CRIATIVO
            if (CTR < minCTR && CVR < minCVR) {
                return {
                    decisao: 'TROCAR CRIATIVO',
                    cor: 'amarelo-ajuste',
                    motivo: CONFIG.MESSAGES.TROCAR_CRIATIVO,
                    sugestoes: CONFIG.MESSAGES.SUGESTOES.TROCAR_CRIATIVO
                };
            }
            
            // Regra 3: AJUSTAR PÚBLICO
            if (CTR < minCTR && CVR >= minCVR) {
                return {
                    decisao: 'AJUSTAR PÚBLICO',
                    cor: 'amarelo-ajuste',
                    motivo: CONFIG.MESSAGES.AJUSTAR_PUBLICO,
                    sugestoes: CONFIG.MESSAGES.SUGESTOES.AJUSTO_PUBLICO
                };
            }
            
            // Regra 4: MELHORAR PÁGINA/OFERTA
            if (CTR >= minCTR && CVR < minCVR) {
                return {
                    decisao: 'MELHORAR PÁGINA',
                    cor: 'amarelo-ajuste',
                    motivo: CONFIG.MESSAGES.MELHORAR_PAGINA,
                    sugestoes: CONFIG.MESSAGES.SUGESTOES.MELHORAR_PAGINA
                };
            }

            // Regra 5: AUMENTAR
            if ((ROAS >= minROAS || CPA <= maxCPA) && (CTR >= minCTR) && (CVR >= minCVR)) {
                let aumento = 15;
                if (ROAS > minROAS * 1.5 || CPA < maxCPA * 0.7) {
                    aumento = 25;
                }
                return {
                    decisao: 'AUMENTAR',
                    cor: 'verde-bom',
                    motivo: CONFIG.MESSAGES.AUMENTAR(aumento),
                    sugestoes: [`Aumente o orçamento em ${aumento}%`]
                };
            }

            // Regra 6: MANTER
            return {
                decisao: 'MANTER',
                cor: 'verde-bom',
                motivo: CONFIG.MESSages.MANTER,
                sugestoes: []
            };
        };


        // --- SEÇÃO 4: RENDERIZAÇÃO DA UI ---

        /**
         * Renderiza os cards das campanhas no dashboard.
         * @param {Array<Object>} campaigns
         */
        const renderCards = (campaigns) => {
            dashboardGrid.innerHTML = '';
            if (campaigns.length === 0) {
                loadingMessage.style.display = 'none';
                noDataMessage.style.display = 'block';
                noDataMessage.innerText = "Não foi encontrada nenhuma campanha em comum entre os dois arquivos CSV. Por favor, verifique se os nomes das campanhas estão idênticos.";
                return;
            }
            noDataMessage.style.display = 'none';

            campaigns.forEach(campaign => {
                const metrics = calculateMetrics(campaign);
                const { decisao, cor, motivo, sugestoes } = makeDecision(metrics, CONFIG.METAS);
                
                const cardHtml = `
                    <div class="card" data-campaign-name="${campaign.meta['Campanha'] || campaign.ga4['Campanha']}">
                        <div class="card-header">
                            <h4 class="card-title">${campaign.meta['Campanha'] || campaign.ga4['Campanha']}</h4>
                            <span class="card-decision status-${cor}">
                                ${decisao}
                            </span>
                        </div>
                        <p class="card-decision-text status-${cor}-text">${motivo}</p>
                        ${campaign.isPartial ? '<span style="font-size: 0.8em; color: gray;">Dados parciais</span>' : ''}
                        
                        <div class="card-metrics">
                            <div class="metric">
                                <span class="metric-value tooltip-container">
                                    ${formatPercent(metrics.CTR)}
                                    <span class="tooltip-text">de cada 100 pessoas que viram, quantas clicaram.</span>
                                </span>
                                <span class="metric-label">CTR</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value tooltip-container">
                                    ${formatCurrency(metrics.Gasto)}
                                    <span class="tooltip-text">quanto você gastou até agora.</span>
                                </span>
                                <span class="metric-label">Gasto</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value tooltip-container">
                                    ${metrics.CPA === Infinity ? '—' : formatCurrency(metrics.CPA)}
                                    <span class="tooltip-text">preço de cada compra.</span>
                                </span>
                                <span class="metric-label">CPA</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value tooltip-container">
                                    ${metrics.ROAS === null ? '—' : metrics.ROAS.toFixed(2)}x
                                    <span class="tooltip-text">quanto voltou de dinheiro para cada R$ 1 investido.</span>
                                </span>
                                <span class="metric-label">ROAS</span>
                            </div>
                        </div>

                        ${sugestoes.length > 0 ? `
                        <div class="card-actions">
                            <strong>Plano de Ação:</strong>
                            <ul>
                                ${sugestoes.map(sug => `<li>${sug}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        <button class="btn btn-secondary" style="margin-top: 20px; width: 100%;" onclick="showDrawer('${campaign.meta['Campanha'] || campaign.ga4['Campanha']}')">Ver detalhes</button>
                    </div>
                `;
                dashboardGrid.innerHTML += cardHtml;
            });
        };

        // --- SEÇÃO 5: GRÁFICOS ---
        const CHART_COLORS = {
            gasto: '#1d4ed8',
            receita: '#28a745',
            pausar: '#dc3545',
            ajuste: '#ffc107',
            manter: '#28a745',
            aumentar: '#28a745',
        };

        const renderCharts = () => {
            if (campaignsToShow.length === 0) {
                chartSection.style.display = 'none';
                return;
            }

            chartSection.style.display = 'flex';
            const gastoCtx = document.getElementById('gasto-chart').getContext('2d');
            const receitaCtx = document.getElementById('receita-chart').getContext('2d');
            const decisoesCtx = document.getElementById('decisoes-chart').getContext('2d');

            // Destruir gráficos existentes antes de criar novos
            if (window.gastoChart) window.gastoChart.destroy();
            if (window.receitaChart) window.receitaChart.destroy();
            if (window.decisoesChart) window.decisoesChart.destroy();

            const campaignLabels = campaignsToShow.map(c => c.meta['Campanha'] || c.ga4['Campanha']);
            const gastoData = campaignsToShow.map(c => calculateMetrics(c).Gasto || 0);
            const receitaData = campaignsToShow.map(c => calculateMetrics(c).ReceitaGA4 || calculateMetrics(c).ReceitaMeta || 0);
            
            const decisoesCounts = { 'PAUSAR': 0, 'AJUSTAR': 0, 'AUMENTAR': 0, 'MANTER': 0 };
            campaignsToShow.forEach(c => {
                const { decisao } = makeDecision(calculateMetrics(c), CONFIG.METAS);
                if (decisao.includes('AJUSTAR') || decisao.includes('TROCAR') || decisao.includes('MELHORAR')) {
                    decisoesCounts['AJUSTAR']++;
                } else {
                    decisoesCounts[decisao]++;
                }
            });

            // Gasto por Campanha (Bar Chart)
            window.gastoChart = new Chart(gastoCtx, {
                type: 'bar',
                data: {
                    labels: campaignLabels,
                    datasets: [{
                        label: 'Gasto (R$)',
                        data: gastoData,
                        backgroundColor: CHART_COLORS.gasto,
                        borderRadius: 8
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });

            // Receita por Campanha (Bar Chart)
            window.receitaChart = new Chart(receitaCtx, {
                type: 'bar',
                data: {
                    labels: campaignLabels,
                    datasets: [{
                        label: 'Receita (R$)',
                        data: receitaData,
                        backgroundColor: CHART_COLORS.receita,
                        borderRadius: 8
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });

            // Decisões por Status (Pie Chart)
            const pieData = Object.values(decisoesCounts);
            const pieLabels = Object.keys(decisoesCounts);
            const pieColors = [
                CHART_COLORS.pausar, 
                CHART_COLORS.ajuste, 
                CHART_COLORS.aumentar, 
                CHART_COLORS.manter
            ];

            window.decisoesChart = new Chart(decisoesCtx, {
                type: 'pie',
                data: {
                    labels: pieLabels,
                    datasets: [{
                        data: pieData,
                        backgroundColor: pieColors
                    }]
                },
                options: { responsive: true }
            });
        };

        // Função de mock para Chart.js simples (sem biblioteca externa)
        function Chart(ctx, config) {
            const type = config.type;
            const data = config.data;
            const options = config.options;
            
            // Destruir o gráfico anterior se existir
            if (ctx.chart) {
                ctx.chart.destroy();
            }

            ctx.chart = this;

            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            if (type === 'bar') {
                const barWidth = 30;
                const gap = 15;
                const chartHeight = ctx.canvas.height;
                const chartWidth = ctx.canvas.width;
                const maxVal = Math.max(...data.datasets[0].data);
                const scale = chartHeight / (maxVal * 1.1);
                
                ctx.fillStyle = '#666';
                ctx.font = '12px Inter';
                ctx.textAlign = 'center';

                data.datasets[0].data.forEach((val, i) => {
                    const x = i * (barWidth + gap) + gap;
                    const barHeight = val * scale;
                    const y = chartHeight - barHeight;
                    ctx.fillStyle = data.datasets[0].backgroundColor;
                    ctx.fillRect(x, y, barWidth, barHeight);
                    ctx.fillStyle = '#333';
                    ctx.fillText(val.toFixed(2), x + barWidth / 2, y - 5);
                });
            } else if (type === 'pie') {
                const total = data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                let startAngle = 0;
                const centerX = ctx.canvas.width / 2;
                const centerY = ctx.canvas.height / 2;
                const radius = Math.min(centerX, centerY) * 0.8;
                
                data.datasets[0].data.forEach((val, i) => {
                    const sliceAngle = (val / total) * 2 * Math.PI;
                    ctx.fillStyle = data.datasets[0].backgroundColor[i];
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Texto
                    const labelX = centerX + radius * Math.cos(startAngle + sliceAngle / 2) * 1.2;
                    const labelY = centerY + radius * Math.sin(startAngle + sliceAngle / 2) * 1.2;
                    ctx.fillStyle = '#333';
                    ctx.textAlign = 'center';
                    ctx.font = '12px Inter';
                    if (val > 0) {
                        ctx.fillText(`${data.labels[i]} (${val})`, labelX, labelY);
                    }
                    startAngle += sliceAngle;
                });
            }
        }

        // --- SEÇÃO 6: EVENTOS E LÓGICA DE DADOS ---
        
        // Exibe uma mensagem de erro na UI
        const showFileError = (message) => {
            fileErrorMessage.innerText = message;
            fileErrorMessage.style.display = 'block';
        };

        // Esconde a mensagem de erro da UI
        const hideFileError = () => {
            fileErrorMessage.style.display = 'none';
        };

        /**
         * Lida com o carregamento dos arquivos e processa os dados.
         * @param {string} source 'meta' or 'ga4'
         * @param {string} content CSV text content
         */
        const processData = (source, content) => {
            hideFileError();
            loadingMessage.style.display = 'block';
            noDataMessage.style.display = 'none';
            dashboardGrid.innerHTML = '';
            
            setTimeout(() => {
                try {
                    const parsed = parseCSV(content);
                    const normalized = mapDataToNormalizedHeaders(parsed, source);
                    if (normalized.length === 0) {
                        throw new Error("O arquivo está vazio ou o formato está incorreto.");
                    }
                    rawData[source] = normalized;
                    updateDashboard();
                } catch (error) {
                    console.error("Erro ao processar o arquivo:", error);
                    showFileError(`Erro ao processar o arquivo: ${error.message}.`);
                    loadingMessage.style.display = 'none';
                }
            }, 100);
        };

        /**
         * Atualiza o dashboard com base nos dados e filtros atuais.
         */
        const updateDashboard = () => {
            loadingMessage.style.display = 'block';
            dashboardGrid.innerHTML = '';
            
            requestAnimationFrame(() => {
                joinedData = joinData(rawData.meta, rawData.ga4);
                
                const filterText = normalizeString(campaignFilterInput.value);
                campaignsToShow = joinedData.filter(c => {
                    const campaignName = normalizeString(c.meta['Campanha'] || c.ga4['Campanha']);
                    return campaignName.includes(filterText);
                });

                renderCards(campaignsToShow);
                renderCharts();
                loadingMessage.style.display = 'none';

                if (joinedData.length > 0) {
                    exportCsvBtn.style.display = 'block';
                    exportPdfBtn.style.display = 'block';
                }
            });
        };
        
        // Carrega as metas do localStorage
        const loadGoals = () => {
            try {
                const savedGoals = JSON.parse(localStorage.getItem('goals'));
                if (savedGoals) {
                    Object.keys(CONFIG.METAS).forEach(goal => {
                        if (savedGoals[goal] !== undefined) {
                            CONFIG.METAS[goal] = savedGoals[goal];
                        }
                    });
                }
            } catch (e) {
                console.error("Não foi possível carregar metas do localStorage.", e);
            }
        };

        // Salva as metas no localStorage
        const saveGoals = () => {
            localStorage.setItem('goals', JSON.stringify(CONFIG.METAS));
        };

        // Sincroniza os sliders com os valores de CONFIG.METAS
        const syncSliders = () => {
            goalsInputs.forEach(input => {
                const goalName = input.id;
                input.value = CONFIG.METAS[goalName];
                document.getElementById(`${goalName}-val`).innerText = formatGoalValue(goalName, input.value);
            });
        };

        // Funçao para formatar os valores dos sliders para exibição
        const formatGoalValue = (goalName, value) => {
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return '—';
            
            if (goalName.includes('CTR') || goalName.includes('CVR')) {
                return `${numValue.toFixed(1)}%`;
            } else if (goalName.includes('CPC') || goalName.includes('CPA') || goalName.includes('Gasto')) {
                return `R$ ${numValue.toFixed(2)}`;
            } else if (goalName.includes('ROAS')) {
                return `${numValue.toFixed(1)}x`;
            }
            return numValue;
        };
        
        // --- SEÇÃO 7: EXPORTAÇÃO ---
        
        const exportCSV = () => {
            // Verifica se há dados para exportar
            if (campaignsToShow.length === 0) {
                showFileError("Nenhum dado para exportar. Por favor, carregue os arquivos primeiro.");
                return;
            }
            
            let csvContent = "Campanha;Decisao;Motivo simples;Proximos passos;Orcamento sugerido\n";
            campaignsToShow.forEach(campaign => {
                const metrics = calculateMetrics(campaign);
                const { decisao, motivo, sugestoes } = makeDecision(metrics, CONFIG.METAS);
                const nomeCampanha = campaign.meta['Campanha'] || campaign.ga4['Campanha'];
                
                let orcamentoSugestao = '';
                if (decisao === 'AUMENTAR') {
                    orcamentoSugestao = sugestoes.length > 0 ? sugestoes[0] : '';
                } else if (decisao === 'PAUSAR') {
                    orcamentoSugestao = 'Pausar';
                } else {
                    orcamentoSugestao = 'Manter';
                }

                // Garante que os valores não contenham ponto e vírgula ou aspas
                const cleanValue = (val) => `"${String(val).replace(/"/g, '""').replace(/;/g, ',')}"`;

                const row = [
                    cleanValue(nomeCampanha),
                    cleanValue(decisao),
                    cleanValue(motivo),
                    cleanValue(sugestoes.join(', ')),
                    cleanValue(orcamentoSugestao)
                ].join(';');
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'plano_de_acao.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        const printReport = () => {
            window.print();
        };

        // --- SEÇÃO 8: MODAL DE DETALHES ---

        const showDrawer = (campaignName) => {
            const campaignData = joinedData.find(c => (c.meta['Campanha'] || c.ga4['Campanha']) === campaignName);
            if (!campaignData) return;

            const metrics = calculateMetrics(campaignData);
            const drawerContent = document.getElementById('drawer-content');
            const drawerTitle = document.getElementById('drawer-title');
            
            drawerTitle.innerText = campaignName;
            
            let html = `
                <h4>Métricas do Meta Ads:</h4>
                <ul>
                    <li><strong>Gasto:</strong> ${formatCurrency(metrics.Gasto)}</li>
                    <li><strong>Impressões:</strong> ${metrics.Impressões || '—'}</li>
                    <li><strong>Cliques:</strong> ${metrics.Cliques || '—'}</li>
                    <li><strong>CTR:</strong> ${formatPercent(metrics.CTR)}</li>
                    <li><strong>CPC:</strong> ${formatCurrency(metrics.CPC)}</li>
                    <li><strong>ROAS:</strong> ${metrics.ROAS?.toFixed(2) || '—'}</li>
                </ul>
            `;
            
            if (campaignData.ga4['Campanha']) {
                html += `
                    <h4>Métricas do GA4:</h4>
                    <ul>
                        <li><strong>Sessões:</strong> ${metrics.SessoesGA4 || '—'}</li>
                        <li><strong>Compras:</strong> ${metrics.ComprasGA4 || '—'}</li>
                        <li><strong>Receita:</strong> ${formatCurrency(metrics.ReceitaGA4)}</li>
                    </ul>
                `;
            } else {
                html += `<p style="color: gray;">Dados do GA4 não encontrados para esta campanha.</p>`;
            }
            
            drawerContent.innerHTML = html;
            drawerModal.style.display = 'flex';
        };

        const hideDrawer = () => {
            drawerModal.style.display = 'none';
        };


        // --- SEÇÃO 9: INICIALIZAÇÃO ---

        document.addEventListener('DOMContentLoaded', () => {
            loadGoals();
            syncSliders();
            updateDashboard();

            // Event Listeners para os botões de upload
            document.getElementById('meta-csv-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    showFileError("Nenhum arquivo selecionado.");
                    return;
                }
                document.getElementById('meta-filename').innerText = file.name;
                const reader = new FileReader();
                reader.onload = (e) => processData('meta', e.target.result);
                reader.onerror = () => showFileError("Erro ao ler o arquivo. Certifique-se de que é um CSV válido.");
                reader.readAsText(file);
            });
            
            document.getElementById('ga4-csv-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    showFileError("Nenhum arquivo selecionado.");
                    return;
                }
                document.getElementById('ga4-filename').innerText = file.name;
                const reader = new FileReader();
                reader.onload = (e) => processData('ga4', e.target.result);
                reader.onerror = () => showFileError("Erro ao ler o arquivo. Certifique-se de que é um CSV válido.");
                reader.readAsText(file);
            });

            document.getElementById('load-example-btn').addEventListener('click', () => {
                document.getElementById('meta-filename').innerText = 'Dados de Exemplo';
                document.getElementById('ga4-filename').innerText = 'Dados de Exemplo';
                hideFileError();
                processData('meta', CONFIG.SAMPLE_DATA.meta);
                processData('ga4', CONFIG.SAMPLE_DATA.ga4);
            });
            
            goalsInputs.forEach(input => {
                input.addEventListener('input', (event) => {
                    const goalName = event.target.id;
                    const value = parseFloat(event.target.value);
                    CONFIG.METAS[goalName] = value;
                    document.getElementById(`${goalName}-val`).innerText = formatGoalValue(goalName, value);
                    saveGoals();
                    updateDashboard();
                });
            });

            campaignFilterInput.addEventListener('input', () => {
                updateDashboard();
            });

            exportCsvBtn.addEventListener('click', exportCSV);
            exportPdfBtn.addEventListener('click', printReport);
            
            closeDrawerBtn.addEventListener('click', hideDrawer);
            window.addEventListener('click', (event) => {
                if (event.target === drawerModal) {
                    hideDrawer();
                }
            });
            window.showDrawer = showDrawer; // Global para o botão no card
        });
    </script>
</body>
</html>
